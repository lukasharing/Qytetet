<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE vxml PUBLIC "-//W3C//DTD VOICEXML 2.0//EN" "http://www.w3.org/TR/voicexml20/vxml.dtd">
<vxml version="2.0" xml:lang="es-ES">
<!--<meta name="author" content="Lukas Haring"/>
<meta name="maintainer" content="lukasharing@correo.ugr.es"/>-->

    <script><![CDATA[

        function getCode(){
            /* Generamos número aleatorio de 4 dígitos */
            var r = (parseInt(Math.random() * 1000) + 1000).toString();
            var code = "";
            /* Cogemos los 3 últimos y le añadimos un break */
            for(var i = r.length - 1; i > 0; --i){
                code += r[i] + "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
            }
            return code;
        }

    ]]></script>

    <!-- http://www1.se.cuhk.edu.hk/~hccl/publications/pub/0300769.pdf -->
    <!-- https://github.com/krishnamuraleedharan/Voice-xml/blob/master/FoodMenu.xml -->
    <!-- https://www.w3.org/Voice/Guide/ -->

    <!-- Si no escucha nada, le volvemos a preguntar -->
    <noinput>
        Lo siento no pude escuchar nada. Podría intentarlo de nuevo?
        <reprompt/>
    </noinput>

    <!-- Si no existe esa seleccion, le deceimos que no lo hemos entendido -->
    <nomatch>
        Lo siento no le pude entender. Podría repetirlo de nuevo?
        <reprompt/>
    </nomatch>

    <!-- Phrases to say when need help-->
    <link event="help">
        <grammar src="./grammatics/help.jsgf" />
    </link>

    <!--<property name="timeout" value="10s"/>-->
    <form id="visitorES">

        <block>
            <prompt bargein="false">
                Bienvenido a Alhambrapp 
            </prompt>
        </block>

        <field name="totalVisitor">
            <prompt timeout="3s">Porfavor, seleccione el numero total de visitantes, incluído menores</prompt>
            <grammar src="./grammatics/num_visitantes.jsgf" />

            <filled>
                <if cond="parseInt(totalVisitor) == 1">
                    <prompt bargein="false">Perfecto, es solo usted</prompt>
                <elseif cond="parseInt(totalVisitor) > 1"/>
                    <prompt bargein="false">Usted dijo <value expr="totalVisitor"/> visitantes</prompt>
                <else/>
                    <clear/>
                    <throw event="nomatch"/>
                </if>
            </filled>

            <!-- Si pedimos ayuda al sistema -->
            <help>
                Debe indicar el numero de visitantes, diga <break/>Un visitante<break/> si es usted el unico visitante.
                <reprompt/>
            </help>
        </field>

        <field name="totalChildren">
            <prompt timeout="3s">Indique cuántos menores hay en el grupo, su entrada será gratuita trás la acreditación en puerta</prompt>
            <grammar src="./grammatics/num_children.jsgf" />

            <filled>
                <if cond="parseInt(totalChildren) >= parseInt(totalVisitor)">
                    <clear namelist="totalChildren" />
                    <prompt bargein="false">Deben haber menos menores que mayores, volvamos a intentarlo</prompt>
                <elseif cond="parseInt(totalChildren) == 0"/>
                    <prompt bargein="false">Usted dijo que no hay menores</prompt>
                <elseif cond="parseInt(totalChildren) == 1"/>
                    <prompt bargein="false">Usted dijo un menor, recuerde que deberá acreditarlo en puerta</prompt>
                <elseif cond="parseInt(totalChildren) > 1"/>
                    <prompt bargein="false">Usted dijo <value expr="totalChildren"/> menores, recuerde que deberá acreditarlo en puerta</prompt>
                <else/>
                    <clear namelist="totalChildren" />
                    <throw event="nomatch"/>
                </if>
            </filled>

            <!-- Si pedimos ayuda al sistema -->
            <help>
                Debe indicar el numero de menores que van a asistir. diga <break/>Ninguno<break/>, si no asistirá ningún menor.
                <reprompt/>
            </help>
        </field>

        <!--
        <field name="visit_type">
            <prompt>Indique el tipo de visita que quiere realizar</prompt>
            <grammar src="./grammatics/visit_type.jsgf" type="application/x-jsgf" />
            <!- Si llenamos ->
            <filled>
                <prompt bargein="false">
                    El tipo de visita selecionada es <value expr="visit_type"/>
                </prompt>
                <!-
                Si estamos editando esta sección, nos enviará a la edición 
                <if cond="dialog.check=='0'">
                    <goto nextitem="edit"/>
                </if>
                ->
            </filled>
            <!- Si pedimos ayuda al sistema->
            <!-<help>
                debe indicar el numero de visitantes, diga el numero uno si es usted el unico visitante
            </help>->
        </field>
        -->
        <field name="Edit">
            <!-- Resumen -->
            <var name="diff" expr="parseInt(totalVisitor) - parseInt(totalChildren)"/>
            <prompt bargein="false"> Le voy a resumir los datos introducidos <break/> </prompt>
            
            <if cond="parseInt(totalChildren) == 1">
                <prompt bargein="false"> Un niño acompañado por</prompt>
            <elseif cond="parseInt(totalChildren) > 1" />
                <prompt bargein="false"> Un grupo de <break/><value expr="totalChildren"/> niños acompañados por</prompt>
            </if>
            
            <if cond="diff == 1">
                <prompt bargein="false"> <break/> Un adulto </prompt>
            <else/>
                <prompt bargein="false">  un grupo de <break/> <value expr="diff.toString()"/> adultos</prompt>
            </if>
            
            <!- Modificar -->
            <prompt>Quiere modificar alguno de los datos anteriores?</prompt>

            <grammar src="./grammatics/yes_no.jsgf" />
    
            <filled>
                <if cond="Edit == 1">
                    <goto nextitem="ToEdit"/>
                <else/>
                    <prompt>El precio es <break/><value expr="15 * diff"/> euros <break type="long" /></prompt>
                    <goto nextitem="ThankYou"/>
                </if>
            </filled>
        </field>

        <field name="ToEdit">
            <prompt>Cuál de los siguientes datos quiere modificar?</prompt>
        </field>

        <block name="ThankYou">
            <var name="code" expr="getCode()"/>
            <prompt>Gracias por realizar su reserva, su código de reserva es <break/> <value expr="code"/>, de nuevo el código de reserva es <break/> <value expr="code"/>  </prompt>
            <!--<submit next="../form.php" namelist="visitor-es"/>-->
            <disconnect/>
        </block>
    </form>
</vxml>